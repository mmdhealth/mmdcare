<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMDCare Platform - Care Provider Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="Assets/mmdconnect.png" alt="MMDCare" class="logo">
                <span class="logo-text">MMDCare</span>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="nav-list">
                    <li class="nav-item active">
                        <img src="Assets/översikt.png" alt="Översikt" class="nav-icon">
                        <span class="nav-text">Översikt</span>
                    </li>
                    <li class="nav-item journaldata">
                        <img src="Assets/journaldata.png" alt="Journaldata" class="nav-icon">
                        <span class="nav-text">Journaldata</span>
                    </li>
                    <li class="nav-item">
                        <a href="gpt-chat.html" class="nav-link">
                            <img src="Assets/halsa-gpt.png" alt="Hälsa+ GPT" class="nav-icon">
                            <span class="nav-text">Hälsa+ GPT</span>
                        </a>
                    </li>
                </ul>
                
                <ul class="nav-list-bottom">
                    <li class="nav-item">
                        <img src="Assets/hjälp.png" alt="Hjälp" class="nav-icon">
                        <span class="nav-text">Hjälp</span>
                    </li>
                    <li class="nav-item">
                        <img src="Assets/inställningar.png" alt="Inställningar" class="nav-icon">
                        <span class="nav-text">Inställningar</span>
                    </li>
                    <li class="nav-item" onclick="showLogoutOverlay()">
                        <img src="Assets/avsluta.png" alt="Avsluta" class="nav-icon">
                        <span class="nav-text">Avsluta</span>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <div class="patient-info">
                    <h1 id="patient-name-header">Patient: <span data-patient-name="full">Anders Boman</span></h1>
                    <p class="patient-date">2024-09-09</p>
                </div>
                <div class="user-info">
                    <span class="user-name" data-doctor-name-source data-doctor-name="full">Dr. Anna Andersson</span>
                    <div class="user-avatar">AA</div>
                </div>
            </div>

            <div class="overview-grid">
                <!-- Main Layout: Journal (50%) | Health Data + Upload (50%) -->
                <div class="main-layout">
                    <!-- Journal Card - 50% Width -->
                    <div class="journal-card card-animate">
                        <h2 class="card-title">Journalanteckningar</h2>
                        <div class="journal-content">
                            <!-- PDF entries will be dynamically added here -->
                        </div>
                    </div>

                    <!-- Right Column - 50% Width with stacked cards -->
                    <div class="right-column">
                    <div class="health-card card-animate">
                        <h2 class="card-title">Provsvar</h2>
                        <div class="organ-list">
                            <a href="heart.html" class="organ-item-link">
                                <div class="organ-item provsvar-card">
                                    <div class="provsvar-main">
                                        <h3 class="organ-name">Provsvar</h3>
                                        <div class="provsvar-status">
                                            <span id="provsvarStatusIndicator" class="status-indicator bad"></span>
                                            <span id="provsvarDataState" class="data-count">Ingen data tillgänglig</span>
                                        </div>
                                    </div>
                                    <div class="chevron">›</div>
                                </div>
                            </a>
                        </div>
                    </div>

                        <!-- File Upload Section -->
                        <div class="upload-card card-animate">
                            <div class="upload-card-header">
                                <h2 class="card-title">Mottagna filer</h2>
                                <button type="button" class="clear-files-btn" onclick="openUploadsDeleteOverlay()" title="Radera filer">
                                    <svg viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M3 6h18" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                                        <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                                        <path d="M10 11v6M14 11v6" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                                        <path d="M5 6l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-14" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                                    </svg>
                                    <span class="sr-only">Radera filer</span>
                                </button>
                            </div>
                            <div class="file-categories" id="file-categories">
                                <!-- File categories will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Logout Overlay -->
    <div id="logout-overlay" class="logout-overlay" style="display: none;">
        <div class="logout-modal">
            <div class="logout-modal-content">
                <div class="logout-info-card">
                    <h3 style="margin: 0 0 8px 0; color: #1D212B; font-size: 20px;">Logga ut</h3>
                    <p style="margin: 0; color: #666; font-size: 16px;">Är du säker på att du vill logga ut från MMDConnect?</p>
                </div>
            </div>
            <div class="logout-modal-actions">
                <button onclick="hideLogoutOverlay()" class="logout-btn-cancel">Avbryt</button>
                <button onclick="confirmLogout()" class="logout-btn-confirm">Logga ut</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let uploadedFiles = [];
        let currentTransferId = null;
        let eventSource = null;
        let lastServerFileCount = 0;
        let currentSessionId = null;

        function logout() {
            showLogoutOverlay();
        }

        // Trigger dashboard page animations
        document.addEventListener('DOMContentLoaded', async function() {
            // CRITICAL: Store session start time ONLY if this is a new session (not a redirect from upload)
            // If we're being redirected from index.html after upload, sessionStartTime should already exist
            // If it doesn't exist, this is a new session after logout - set it now
            if (!localStorage.getItem('sessionStartTime')) {
                localStorage.removeItem('uploadNotificationShownForSession');
                const sessionStartTime = Date.now();
                localStorage.setItem('sessionStartTime', sessionStartTime.toString());
                console.log('New session started after logout, timestamp:', sessionStartTime);
            } else {
                console.log('Existing session, timestamp:', localStorage.getItem('sessionStartTime'));
            }
            currentSessionId = localStorage.getItem('sessionStartTime');
            
            // Update patient name immediately on page load
            const savedPatientName = localStorage.getItem('currentPatientName');
            if (savedPatientName) {
                const patientNameHeader = document.getElementById('patient-name-header');
                if (patientNameHeader) {
                    patientNameHeader.textContent = `Patient: ${savedPatientName}`;
                }
            }
            
            // Animate cards with staggered timing
            const cards = document.querySelectorAll('.card-animate');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('loaded');
                }, 100 + (index * 100));
            });
            
            // Initialize file upload functionality (will load ONLY new files)
            initializeFileUpload();
            
            // Add escape key listener for logout overlay
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    hideLogoutOverlay();
                }
            });
        });

        async function initializeFileUpload() {
            console.log('Dashboard initializeFileUpload - Starting with loading state');
            
            const categoriesContainer = document.getElementById('file-categories');
            const journalContent = document.querySelector('.journal-content');
            
            if (categoriesContainer) {
                categoriesContainer.innerHTML = '<p class="empty-category">Laddar filer...</p>';
            }
            
            // Update patient name from localStorage
            const savedPatientName = localStorage.getItem('currentPatientName');
            if (savedPatientName) {
                const patientNameHeader = document.getElementById('patient-name-header');
                if (patientNameHeader) {
                    patientNameHeader.textContent = `Patient: ${savedPatientName}`;
                    console.log('Updated patient name to:', savedPatientName);
                }
            }
            
            // STEP 4: Get transferId from redirect and load ONLY new files
            const savedTransferId = localStorage.getItem('currentTransferId');
            console.log('Checking for transfer ID from redirect:', savedTransferId);
            
            if (savedTransferId) {
                // Verify the transfer exists on the server and has files
                try {
                    const verifyResponse = await fetch(`/api/files?transferId=${savedTransferId}`, {
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (verifyResponse.ok) {
                        const verifyData = await verifyResponse.json();
                        console.log('Transfer verification response:', verifyData);
                        console.log('Files in transfer:', verifyData.files?.length || 0);
                        
                        // CRITICAL: Only load files if they exist on server
                        // These are the NEW files - old files already cleared above
                        if (verifyData.files && verifyData.files.length > 0) {
                            currentTransferId = savedTransferId;
                            console.log('✅ Loading NEW files from server:', currentTransferId, 'File count:', verifyData.files.length);
                            await loadUploadedFiles();
                            startFileEventStream();
                        } else {
                            // No files on server - show empty
                            console.log('Transfer has no files - showing empty');
                            localStorage.removeItem('currentTransferId');
                            currentTransferId = null;
                            uploadedFiles = [];
                            updateFileDisplay();
                        }
                    } else {
                        // Transfer doesn't exist - show empty
                        console.log('Transfer not found on server - showing empty');
                        localStorage.removeItem('currentTransferId');
                        currentTransferId = null;
                        uploadedFiles = [];
                        updateFileDisplay();
                    }
                } catch (error) {
                    console.error('Error verifying transfer:', error);
                    localStorage.removeItem('currentTransferId');
                    currentTransferId = null;
                    uploadedFiles = [];
                    updateFileDisplay();
                }
            } else {
                // No transferId - empty state
                console.log('No transfer ID - showing empty state');
                currentTransferId = null;
                uploadedFiles = [];
                updateFileDisplay();
            }
        }

        async function loadUploadedFiles() {
            if (!currentTransferId) {
                console.log('No transfer ID available for loading files');
                uploadedFiles = [];
                updateFileDisplay();
                return;
            }

            console.log('Loading files for transfer ID:', currentTransferId);
            
            try {
                // Load files ONLY from API endpoint (in-memory server state)
                // NEVER load from localStorage, blob storage, or any persistent storage
                // The server will return empty array if transfer was cleared by logout
                const url = `/api/files?transferId=${currentTransferId}`;
                console.log('Fetching files from API:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                console.log('API response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Loaded files data from API:', data);
                    console.log('Files array:', data.files);
                    
                    // CRITICAL: Trust the server - if it returns files, they're from current session
                    // Server ensures all transfers are cleared on logout, so files here are current
                    uploadedFiles = data.files || [];
                    console.log('✅ Number of files loaded from API:', uploadedFiles.length);
                    console.log('Files details:', uploadedFiles);
                    lastServerFileCount = uploadedFiles.length;
                    
                    // Display files if we have any
                    if (uploadedFiles.length > 0) {
                        // Clear old localStorage file data before saving new
                        Object.keys(localStorage).forEach(key => {
                            if (key.startsWith('mmd_files_') || key === 'uploadedFiles') {
                                localStorage.removeItem(key);
                            }
                        });
                        
                        saveFilesToStorage(); // Save to localStorage for this session
                        updateFileDisplay();
                        
                        // Show notification for mobile files
                        showFileNotification({ size: 0 }); // Special notification for mobile files
                        
                        // Load imported journal notes if any PDF files exist
                        await loadImportedJournalNotes();
                    } else {
                        // No files found - ensure everything is cleared
                        uploadedFiles = [];
                        updateFileDisplay();
                        console.log('No files found for this transfer - clean state');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load files from API, status:', response.status);
                    console.error('Error response:', errorText);
                    
                    // API failed - clear everything
                    uploadedFiles = [];
                    lastServerFileCount = 0;
                    updateFileDisplay();
                    console.log('API failed - cleared all data');
                }
            } catch (error) {
                console.error('Failed to load uploaded files from mobile app:', error);
                // On error - clear everything
                uploadedFiles = [];
                lastServerFileCount = 0;
                updateFileDisplay();
            }
        }

        async function loadImportedJournalNotes() {
            if (!currentTransferId) return;
            
            // Find PDF files in the uploaded files
            const pdfFiles = uploadedFiles.filter(file => 
                file.mimetype === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
            );
            
            const journalContent = document.querySelector('.journal-content');
            
            if (pdfFiles.length > 0) {
                // Clear existing PDF cards and empty state
                journalContent.innerHTML = '';
                
                // Create a card for each PDF file
                for (const pdfFile of pdfFiles) {
                    try {
                        // Load PDF content from mobile app
                        const response = await fetch(`/api/pdf-content?transferId=${currentTransferId}&filename=${encodeURIComponent(pdfFile.name)}`);
                        
                        if (response.ok) {
                            const parsedData = await response.json();
                            const pdfCard = createPDFJournalCard(pdfFile, parsedData);
                            journalContent.appendChild(pdfCard);
                        } else {
                            console.error(`Failed to load PDF content for ${pdfFile.name}, status:`, response.status);
                            // Create a basic card even if content loading fails
                            const basicCard = createBasicPDFCard(pdfFile);
                            journalContent.appendChild(basicCard);
                        }
                    } catch (error) {
                        console.error(`Failed to load PDF content for ${pdfFile.name}:`, error);
                        // Create a basic card even if content loading fails
                        const basicCard = createBasicPDFCard(pdfFile);
                        journalContent.appendChild(basicCard);
                    }
                }
            } else {
                showEmptyJournalState();
            }
        }

        function formatStructuredContent(content) {
            // If content is a string (old format), return it as is
            if (typeof content === 'string') {
                return `<h4>Importerad Journalanteckning</h4><p>${content}</p>`;
            }
            
            // If content is structured (new format), show sections with proper hierarchy
            if (typeof content === 'object' && content !== null) {
                let html = '<h4>Importerad Journalanteckning</h4>';
                
                // Check if it's the new structured format with sections array
                if (content.sections && Array.isArray(content.sections)) {
                    // New structured format with sections - simple hierarchy within main card
                    content.sections.forEach(section => {
                        html += `<div style="margin-bottom: 12px;">`;
                        // Match the style of "Importerad Journalanteckning" by using a plain h4 without custom sizing
                        html += `<h4>${section.heading}</h4>`;
                        // Match the style of the summary text above by reusing the journal-summary class
                        html += `<p class="journal-summary">${section.content}</p>`;
                        html += `</div>`;
                    });
                } else {
                    // Old key-based format - combine all content into one readable text
                    let fullContent = '';
                    
                    // Define section order and Swedish labels
                    const sectionOrder = [
                        { key: 'anamnes', label: 'Anamnes' },
                        { key: 'status', label: 'Status' },
                        { key: 'undersokningar', label: 'Undersökningar' },
                        { key: 'bedomning', label: 'Bedömning' },
                        { key: 'rekommendationer', label: 'Rekommendationer' },
                        { key: 'medicin', label: 'Medicin/Behandling' }
                    ];
                    
                    // Add structured sections to full content
                    sectionOrder.forEach(section => {
                        if (content[section.key]) {
                            fullContent += `<strong>${section.label}:</strong> ${content[section.key]}\n\n`;
                        }
                    });
                    
                    // Add other content if any
                    if (content.other && content.other.length > 0) {
                        fullContent += `<strong>Övrig information:</strong> ${content.other.join(' ')}\n\n`;
                    }
                    
                    // Display as single paragraph with line breaks
                    html += `<div class="journal-full-content"><p>${fullContent.replace(/\n\n/g, '</p><p>')}</p></div>`;
                }
                
                return html;
            }
            
            // Fallback
            return `<h4>Importerad Journalanteckning</h4><p>Innehållet kunde inte formateras korrekt.</p>`;
        }

        function createPDFJournalCard(pdfFile, parsedData) {
            const card = document.createElement('div');
            card.className = 'journal-entry pdf-journal-entry';
            card.onclick = () => toggleJournalEntry(card);
            
            // Use the parsed data from the server
            const title = parsedData.title || generatePDFTitle(parsedData.content, pdfFile.name);
            const doctor = parsedData.doctor || 'Importerad från PDF';
            const date = parsedData.date || new Date(pdfFile.uploadedAt || Date.now()).toLocaleDateString('sv-SE');
            const summary = parsedData.summary || generatePDFSummary(parsedData.content);
            
            card.innerHTML = `
                <div class="journal-header">
                    <div class="journal-info">
                        <h3 class="journal-title">${title}</h3>
                        <p class="journal-doctor">${doctor}</p>
                        <p class="journal-date">${date}</p>
                        <p class="journal-summary">${summary}</p>
                    </div>
                    <div class="chevron">›</div>
                </div>
                <div class="journal-details">
                    <div class="journal-actions">
                        <button class="gpt-summarize-btn" onclick="event.stopPropagation(); summarizeWithGPT(this)">
                            <img src="Assets/halsa-gpt.png" alt="Hälsa+GPT" style="width: 16px; height: 16px;">
                            Summera med Hälsa+GPT
                        </button>
                    </div>
                    <div class="journal-content-detail">
                        ${formatStructuredContent(parsedData.content)}
                    </div>
                </div>
            `;
            
            return card;
        }

        function createBasicPDFCard(pdfFile) {
            const card = document.createElement('div');
            card.className = 'journal-entry pdf-journal-entry';
            card.onclick = () => toggleJournalEntry(card);
            
            const uploadDate = new Date(pdfFile.uploadedAt || Date.now()).toLocaleDateString('sv-SE');
            
            card.innerHTML = `
                <div class="journal-header">
                    <div class="journal-info">
                        <h3 class="journal-title">${pdfFile.name}</h3>
                        <p class="journal-doctor">Importerad från PDF</p>
                        <p class="journal-date">${uploadDate}</p>
                        <p class="journal-summary">PDF-fil importerad från mobilen. Innehåll kunde inte analyseras.</p>
                    </div>
                    <div class="chevron">›</div>
                </div>
                <div class="journal-details">
                    <div class="journal-actions">
                        <button class="gpt-summarize-btn" onclick="event.stopPropagation(); summarizeWithGPT(this)">
                            <img src="Assets/halsa-gpt.png" alt="Hälsa+GPT" style="width: 16px; height: 16px;">
                            Summera med Hälsa+GPT
                        </button>
                    </div>
                    <div class="journal-content-detail">
                        <h4>PDF-fil:</h4>
                        <p>Filnamn: ${pdfFile.name}</p>
                        <p>Storlek: ${Math.round(pdfFile.size / 1024)} KB</p>
                        <p>Typ: ${pdfFile.mimetype}</p>
                    </div>
                </div>
            `;
            
            return card;
        }

        function generatePDFTitle(content, filename) {
            // Try to extract a meaningful title from the content
            if (typeof content === 'object' && content.anamnes) {
                // Look for common medical terms in anamnes
                const anamnes = content.anamnes.toLowerCase();
                if (anamnes.includes('kontroll') || anamnes.includes('uppföljning')) {
                    return 'Uppföljning - ' + extractPatientInfo(content);
                } else if (anamnes.includes('akut') || anamnes.includes('besvär')) {
                    return 'Akutbesök - ' + extractPatientInfo(content);
                } else if (anamnes.includes('operation') || anamnes.includes('kirurgi')) {
                    return 'Operation - ' + extractPatientInfo(content);
                }
            }
            
            // Fallback to filename or generic title
            const cleanFilename = filename.replace(/\.pdf$/i, '').replace(/[_-]/g, ' ');
            return cleanFilename || 'Importerad Journalanteckning';
        }

        function extractPatientInfo(content) {
            if (typeof content === 'object' && content.anamnes) {
                // Try to extract age, gender, or condition from anamnes
                const anamnes = content.anamnes;
                const ageMatch = anamnes.match(/(\d+)\s*år/);
                const genderMatch = anamnes.match(/(man|kvinna|patient)/i);
                
                if (ageMatch && genderMatch) {
                    return `${genderMatch[1]} ${ageMatch[1]} år`;
                } else if (ageMatch) {
                    return `${ageMatch[1]} år`;
                }
            }
            return 'Patient';
        }

        function generatePDFSummary(content) {
            if (typeof content === 'object') {
                if (content.bedömning) {
                    return content.bedömning.substring(0, 80) + (content.bedömning.length > 80 ? '...' : '');
                } else if (content.status) {
                    return content.status.substring(0, 80) + (content.status.length > 80 ? '...' : '');
                } else if (content.anamnes) {
                    return content.anamnes.substring(0, 80) + (content.anamnes.length > 80 ? '...' : '');
                }
            } else if (typeof content === 'string') {
                return content.substring(0, 80) + (content.length > 80 ? '...' : '');
            }
            return 'Importerad journalanteckning från PDF-fil.';
        }

        function replaceJournalEntriesWithImported(importedContent) {
            const journalContent = document.querySelector('.journal-content');
            if (!journalContent) return;
            
            // Create a new journal entry based on imported content
            const newEntry = document.createElement('div');
            newEntry.className = 'journal-entry';
            newEntry.onclick = function() { toggleJournalEntry(this); };
            
            newEntry.innerHTML = `
                <div class="journal-header">
                    <div class="journal-info">
                        <h3 class="journal-title">${importedContent.title}</h3>
                        <p class="journal-doctor">${importedContent.doctor}</p>
                        <p class="journal-date">${importedContent.date}</p>
                        <p class="journal-summary">${importedContent.summary}</p>
                    </div>
                    <div class="chevron">›</div>
                </div>
                <div class="journal-details">
                    <div class="journal-actions">
                        <button class="gpt-summarize-btn" onclick="event.stopPropagation(); summarizeWithGPT(this)">
                            <img src="Assets/halsa-gpt.png" alt="Hälsa+GPT" style="width: 16px; height: 16px;">
                            Summera med Hälsa+GPT
                        </button>
                    </div>
                    <div class="journal-content-detail">
                        ${formatStructuredContent(importedContent.content)}
                    </div>
                </div>
            `;
            
            // Replace all existing journal entries with the imported one
            journalContent.innerHTML = '';
            journalContent.appendChild(newEntry);
        }

        function startFileEventStream() {
            if (!currentTransferId) return;

            // Note: EventSource is not available for cross-origin requests in serverless
            // We'll rely on the polling mechanism from the login page instead
            console.log('EventSource not available for cross-origin serverless apps - using polling instead');
            
            // CRITICAL: Store initial file count to detect NEW uploads only
            lastServerFileCount = uploadedFiles.length;
            console.log('Starting file event stream with current file count:', lastServerFileCount);
            
            // Start polling for new files every 10 seconds
            const pollForFiles = async () => {
                try {
                    const response = await fetch(`/api/files?transferId=${currentTransferId}`, {
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate'
                        }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const serverFiles = data.files || [];
                        
                        // CRITICAL: Only update if we have MORE files than when we started
                        // This ensures we only show files uploaded in THIS session
                        if (serverFiles.length > lastServerFileCount) {
                            console.log('New files detected, refreshing display');
                            
                            // Only get the NEW files (after last count)
                            const newFiles = serverFiles.slice(lastServerFileCount);
                            
                            // Show notification for each new file
                            newFiles.forEach(file => {
                                showFileNotification(file);
                            });
                            
                            // Update with all files from server (but only new ones trigger notification)
                            uploadedFiles = serverFiles;
                            saveFilesToStorage();
                            updateFileDisplay();
                            await loadImportedJournalNotes();
                            lastServerFileCount = serverFiles.length;
                        } else if (serverFiles.length < lastServerFileCount) {
                            // Server has fewer files - reset to server state (logout cleared them)
                            console.log('Server has fewer files - resetting to server state');
                            uploadedFiles = serverFiles;
                            updateFileDisplay();
                            lastServerFileCount = serverFiles.length;
                        }
                    }
                } catch (error) {
                    console.error('Failed to poll for new files:', error);
                }
            };
            
            // Poll immediately and then every 10 seconds
            pollForFiles();
            setInterval(pollForFiles, 10000);
        }

        function updateFileDisplay() {
            const categoriesContainer = document.getElementById('file-categories');
            console.log('=== UPDATE FILE DISPLAY ===');
            console.log('Updating file display with', uploadedFiles.length, 'files');
            console.log('Files array:', uploadedFiles);

            if (uploadedFiles.length === 0) {
                console.log('No files to display, showing empty message');
                categoriesContainer.innerHTML = '<p class="empty-category">Inga filer att visa</p>';
                showEmptyJournalState();
                updateProvsvarStatus();
                return;
            }

            // Categorize files by type
            const categorized = categorizeFilesByType(uploadedFiles);
            console.log('Categorized files by type:', categorized);
            
            // Render categories
            categoriesContainer.innerHTML = '';
            
            const categoryConfigs = [
                { key: 'excel', name: 'Provsvar', icon: '' },
                { key: 'pdf', name: 'Journalanteckningar', icon: '' }
            ];

            let totalDisplayed = 0;
            categoryConfigs.forEach(config => {
                const files = categorized[config.key] || [];
                console.log(`Category ${config.name}: ${files.length} files`);
                if (files.length > 0) {
                    const categoryDiv = createCategoryElement(config, files);
                    categoriesContainer.appendChild(categoryDiv);
                    totalDisplayed += files.length;
                }
            });
            
            console.log(`Total files displayed: ${totalDisplayed}`);
            console.log('=== END UPDATE FILE DISPLAY ===');
            updateProvsvarStatus();
        }

        function updateProvsvarStatus() {
            const indicator = document.getElementById('provsvarStatusIndicator');
            const stateEl = document.getElementById('provsvarDataState');
            if (!indicator || !stateEl) return;
            
            const hasExcelData = uploadedFiles.some(file =>
                file.mimetype === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                file.mimetype === 'application/vnd.ms-excel' ||
                file.name.toLowerCase().endsWith('.xlsx') ||
                file.name.toLowerCase().endsWith('.xls')
            );
            
            indicator.classList.remove('good', 'bad');
            indicator.classList.add(hasExcelData ? 'good' : 'bad');
            stateEl.textContent = hasExcelData ? 'Data tillgänglig' : 'Ingen data tillgänglig';
        }

        function createCategoryElement(config, files) {
            const div = document.createElement('div');
            div.className = 'file-category-expandable';
            
            const header = document.createElement('div');
            header.className = 'category-header';
            header.innerHTML = `
                <div class="category-title-row">
                    <h3 class="category-title">${config.name}</h3>
                    <span class="file-count">${files.length}</span>
                </div>
                <div class="chevron">›</div>
            `;
            
            const fileList = document.createElement('div');
            fileList.className = 'file-list-vertical';
            fileList.style.display = 'none'; // Initially hidden
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item-vertical';
                
                const fileType = file.mimetype === 'application/pdf' ? 'pdf' : 'excel';
                const fileDate = new Date(file.uploadedAt).toLocaleDateString('sv-SE');
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name file-type-${fileType}">${file.name}</div>
                        <div class="file-details">
                            <span class="file-date">${fileDate}</span>
                            <span class="file-size">${Math.round(file.size/1024)} KB</span>
                        </div>
                    </div>
                `;
                
                fileList.appendChild(fileItem);
            });
            
            // Add click handler for expand/collapse
            header.addEventListener('click', () => {
                const isExpanded = fileList.style.display !== 'none';
                fileList.style.display = isExpanded ? 'none' : 'flex';
                div.classList.toggle('expanded', !isExpanded);
            });
            
            div.appendChild(header);
            div.appendChild(fileList);
            
            return div;
        }

        function categorizeFilesByType(files) {
            console.log('=== CATEGORIZING FILES ===');
            console.log('Input files:', files);
            
            const categories = {
                excel: [],
                pdf: []
            };

            files.forEach(file => {
                console.log('Processing file:', file.name, 'mimetype:', file.mimetype);
                
                if (file.mimetype === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || 
                    file.name.toLowerCase().endsWith('.xlsx')) {
                    console.log('File categorized as Excel:', file.name);
                    categories.excel.push(file);
                } else if (file.mimetype === 'application/pdf' || 
                           file.name.toLowerCase().endsWith('.pdf')) {
                    console.log('File categorized as PDF:', file.name);
                    categories.pdf.push(file);
                } else {
                    // Default to PDF for unknown types
                    console.log('File categorized as PDF (default):', file.name);
                    categories.pdf.push(file);
                }
            });

            console.log('Final categories:', categories);
            console.log('=== END CATEGORIZING FILES ===');
            return categories;
        }

        function categorizeFiles(files) {
            const categories = {
                heart: [],
                bp: [],
                glucose: [],
                activity: [],
                notes: [],
                other: []
            };

            files.forEach(file => {
                const name = file.name.toLowerCase();
                let categorized = false;

                // Heart-related files
                if (/\b(ecg|ekg|heart|cardio|pulse|hjärta|hjärt)\b/.test(name)) {
                    categories.heart.push(file);
                    categorized = true;
                }
                // Blood pressure files
                else if (/\b(bp|blood[- ]?pressure|systolic|diastolic|blodtryck)\b/.test(name)) {
                    categories.bp.push(file);
                    categorized = true;
                }
                // Glucose/blood sugar files
                else if (/\b(glucose|bg|cgm|hba1c|a1c|glukos|blodsocker)\b/.test(name)) {
                    categories.glucose.push(file);
                    categorized = true;
                }
                // Activity/fitness files
                else if (/\b(steps|activity|workout|hrv|vo2|fitness|aktivitet|träning)\b/.test(name)) {
                    categories.activity.push(file);
                    categorized = true;
                }
                // Notes/journal files
                else if (/\b(note|journal|anteckning|anteckningar|journalanteckningar|notat)\b/.test(name)) {
                    categories.notes.push(file);
                    categorized = true;
                }

                if (!categorized) {
                    categories.other.push(file);
                }
            });

            return categories;
        }

        function showFileNotification(file) {
            // Create a temporary notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                color: #1f2937;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                font-size: 14px;
                max-width: 500px;
                white-space: nowrap;
                border: 1px solid #e5e7eb;
                animation: slideIn 0.3s ease-out;
            `;
            
            if (file.size === 0) {
                const sessionId = localStorage.getItem('sessionStartTime') || 'default';
                const alreadyShown = localStorage.getItem('uploadNotificationShownForSession');
                if (alreadyShown === sessionId) {
                    return;
                }
                localStorage.setItem('uploadNotificationShownForSession', sessionId);
                // Special case for welcome message
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 12px; height: 12px; background: #059669; border-radius: 50%; flex-shrink: 0;"></div>
                        <div>
                            <div style="font-weight: 600;">Filer från patientens mobil har laddats upp</div>
                        </div>
                    </div>
                `;
            } else {
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 12px; height: 12px; background: #059669; border-radius: 50%; flex-shrink: 0;"></div>
                        <div>
                            <div style="font-weight: 600;">Ny fil mottagen</div>
                            <div style="font-size: 12px; color: #6b7280;">${file.name}</div>
                        </div>
                    </div>
                `;
            }
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    notification.remove();
                    style.remove();
                }, 300);
            }, 4000);
        }

        async function refreshUploadedFiles() {
            await loadUploadedFiles();
        }

        function saveFilesToStorage() {
            // Save uploaded files to localStorage so they persist
            localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
            console.log('Saved', uploadedFiles.length, 'files to localStorage');
        }

        function loadFilesFromStorage() {
            // Load previously saved files from localStorage
            const savedFiles = localStorage.getItem('uploadedFiles');
            if (savedFiles) {
                uploadedFiles = JSON.parse(savedFiles);
                console.log('Loaded', uploadedFiles.length, 'files from localStorage');
                updateFileDisplay();
                
                // Also load journal notes if there are PDF files
                const pdfFiles = uploadedFiles.filter(file => 
                    file.mimetype === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
                );
                if (pdfFiles.length > 0) {
                    loadImportedJournalNotes();
                } else {
                    showEmptyJournalState();
                }
            } else {
                showEmptyJournalState();
            }
        }

        function showEmptyJournalState() {
            const journalContent = document.querySelector('.journal-content');
            if (journalContent && journalContent.children.length === 0) {
                journalContent.innerHTML = `
                    <div class="empty-journal-state">
                        <p>Inga journalanteckningar tillgängliga ännu.</p>
                        <p class="empty-hint">Ladda upp PDF-filer från din mobil för att se importerade journalanteckningar här.</p>
                    </div>
                `;
            }
        }

        function clearAllFiles() {
            // Clear all saved files (for logout or manual clear)
            uploadedFiles = [];
            lastServerFileCount = 0;
            
            // Clear ALL localStorage file data
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('mmd_files_') || key === 'uploadedFiles') {
                    localStorage.removeItem(key);
                    console.log('clearAllFiles cleared:', key);
                }
            });
            
            // CRITICAL: Clear the file display immediately to remove any old files (Excel, PDF, etc.)
            const categoriesContainer = document.getElementById('file-categories');
            if (categoriesContainer) {
                categoriesContainer.innerHTML = '<p class="empty-category">Inga filer att visa</p>';
            }
            
            // Clear journal content
            const journalContent = document.querySelector('.journal-content');
            if (journalContent) {
                journalContent.innerHTML = '';
            }
            
            updateFileDisplay();
            showEmptyJournalState();
            updateProvsvarStatus();
            
            console.log('Cleared all files and localStorage');
        }

        async function performDeleteUploads(selectedIds = null) {
            if (!uploadedFiles.length) {
                showEmptyJournalState();
                updateProvsvarStatus();
                return;
            }
            const transferToDelete = currentTransferId || localStorage.getItem('currentTransferId');
            
            if (!selectedIds || selectedIds.length === uploadedFiles.length) {
                clearAllFiles();
                showEmptyJournalState();
                updateProvsvarStatus();
                
                if (transferToDelete) {
                    try {
                        await fetch(`/delete-all/${transferToDelete}`, { method: 'DELETE' });
                        console.log('Deleted files for transfer:', transferToDelete);
                    } catch (error) {
                        console.warn('Failed to delete transfer files on server (expected on Vercel):', error);
                    }
                }
                return;
            }
            
            uploadedFiles = uploadedFiles.filter(file => !selectedIds.includes(file.name));
            saveFilesToStorage();
            updateFileDisplay();
            await loadImportedJournalNotes();
            updateProvsvarStatus();
            
            if (transferToDelete) {
                try {
                    await fetch(`/api/files?transferId=${transferToDelete}&delete=${selectedIds.map(encodeURIComponent).join(',')}`, {
                        method: 'POST'
                    });
                } catch (error) {
                    console.warn('Partial delete endpoint not implemented, local files removed only');
                }
            }
        }

        function openUploadsDeleteOverlay() {
            if (!uploadedFiles.length) {
                showEmptyJournalState();
                updateProvsvarStatus();
                return;
            }
            
            const dateLabel = new Date().toLocaleDateString('sv-SE');
            const filesList = uploadedFiles.map(file => `
                <label class="delete-file-item">
                    <input type="checkbox" class="delete-file-checkbox" value="${file.name}" checked>
                    <span>
                        <span class="file-name">${file.name}</span>
                        <span class="file-meta">${new Date(file.uploadedAt).toLocaleDateString('sv-SE')} • ${Math.round(file.size/1024)} KB</span>
                    </span>
                </label>
            `).join('');
            
            const title = uploadedFiles.length === 1 ? uploadedFiles[0].name : `${uploadedFiles.length} filer valda`;
            const dateLabel = new Date().toLocaleDateString('sv-SE');
            
            const overlayHTML = `
                <div class="delete-overlay" id="uploadsDeleteOverlay">
                    <div class="delete-modal">
                        <div class="delete-modal-header">
                            <h2 class="delete-modal-title">Radera filer</h2>
                            <p class="delete-modal-subtitle">Är du säker på att du vill radera alla mottagna filer?</p>
                        </div>
                        <div class="delete-modal-content">
                            <div class="delete-info-card">
                                <div class="delete-info-header">
                                    <div>
                                        <h4 class="delete-info-title">${title}</h4>
                                        <p class="delete-info-text">Datum: ${dateLabel}</p>
                                    </div>
                                    <button class="select-all-btn" onclick="toggleSelectAllFiles()">Markera alla</button>
                                </div>
                                <div class="delete-files-list">
                                    ${filesList}
                                </div>
                                <p class="delete-info-text" style="margin-top: 12px; font-style: italic; color: #999;">Denna åtgärd kan inte ångras.</p>
                            </div>
                        </div>
                        <div class="delete-modal-actions">
                            <button class="delete-btn-cancel" onclick="closeUploadsDeleteOverlay()">Avbryt</button>
                            <button class="delete-btn-confirm" onclick="confirmUploadsDelete()">
                                <svg class="delete-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"></polyline>
                                    <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                                Radera
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', overlayHTML);
            const overlay = document.getElementById('uploadsDeleteOverlay');
            requestAnimationFrame(() => overlay.classList.add('active'));
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeUploadsDeleteOverlay();
                }
            });
            
            document.addEventListener('keydown', handleUploadsDeleteEscapeKey);
        }

        function closeUploadsDeleteOverlay() {
            const overlay = document.getElementById('uploadsDeleteOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                setTimeout(() => overlay.remove(), 300);
            }
            document.removeEventListener('keydown', handleUploadsDeleteEscapeKey);
        }

        function handleUploadsDeleteEscapeKey(e) {
            if (e.key === 'Escape') {
                closeUploadsDeleteOverlay();
            }
        }

        async function confirmUploadsDelete() {
            const confirmBtn = document.querySelector('#uploadsDeleteOverlay .delete-btn-confirm');
            if (!confirmBtn) return;
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = 'Raderar...';
            confirmBtn.disabled = true;
            
            await performDeleteUploads();
            
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
            closeUploadsDeleteOverlay();
        }


        function showLogoutOverlay() {
            const overlay = document.getElementById('logout-overlay');
            overlay.style.display = 'flex';
            setTimeout(() => {
                overlay.classList.add('active');
            }, 10);
        }

        function hideLogoutOverlay() {
            const overlay = document.getElementById('logout-overlay');
            overlay.classList.remove('active');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        }


        async function confirmLogout() {
            console.log('LOGOUT: Resetting entire platform - deleting ALL files');
            
            // STEP 1: Clear UI immediately - remove ALL files (PDF and Excel)
            uploadedFiles = [];
            currentTransferId = null;
            
            const categoriesContainer = document.getElementById('file-categories');
            if (categoriesContainer) {
                categoriesContainer.innerHTML = '<p class="empty-category">Inga filer att visa</p>';
            }
            
            const journalContent = document.querySelector('.journal-content');
            if (journalContent) {
                journalContent.innerHTML = '';
            }
            
            updateFileDisplay();
            clearAllFiles();
            
            // STEP 2: Delete ALL files from server FIRST
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    console.log('✅ Server deleted ALL files and transfers');
                } else {
                    console.error('Failed to delete server files');
                }
            } catch (error) {
                console.error('Error deleting server files:', error);
            }
            
            // STEP 3: Wait for server to complete deletion
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // STEP 4: Clear ALL localStorage - EVERYTHING related to files
            const allKeys = Object.keys(localStorage);
            allKeys.forEach(key => {
                if (key.startsWith('mmd_files_') || 
                    key.startsWith('transfer_') || 
                    key.startsWith('patient_transfer_') ||
                    key === 'currentTransferId' ||
                    key === 'currentPatientName' ||
                    key === 'uploadedFiles' ||
                    key === 'sessionStartTime' ||
                    key === 'uploadNotificationShownForSession') {
                    localStorage.removeItem(key);
                    console.log('Deleted:', key);
                }
            });
            
            // Clear auth (but keep for login)
            localStorage.removeItem('hasSeenLogin');
            localStorage.removeItem('mmdcare_auth');
            
            console.log('✅ Platform completely reset - all files deleted');
            
            // Close event streams
            if (eventSource) {
                eventSource.close();
            }
            
            hideLogoutOverlay();
            
            // Redirect to login
            window.location.href = 'login.html';
        }

    </script>
</body>
</html>
