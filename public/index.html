<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MMDCare ‚Äì Juridiskt sessionfl√∂de</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F0F2F5;
            color: #1D212B;
        }
        .page-shell {
            max-width: 1040px;
            margin: 0 auto;
            padding: 40px 24px 56px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .page-header {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 24px;
            max-width: 520px;
        }
        .eyebrow {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #6B7280;
            font-weight: 600;
        }
        .page-header h1 {
            margin: 4px 0 8px;
            font-size: 28px;
            font-weight: 600;
            color: #0F172A;
        }
        .page-header p {
            margin: 0;
            color: #4B5563;
            max-width: 640px;
            line-height: 1.5;
        }
        .chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .chip {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: #E5E7EB;
            color: #374151;
            font-weight: 500;
        }
        .wizard-layout {
            width: 100%;
            max-width: 980px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            align-items: stretch;
        }
        .step-grid {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 24px;
        }
        .step-card {
            display: flex;
            flex-direction: column;
            gap: 14px;
            min-height: 100%;
            transition: opacity 0.2s ease;
        }
        .step-card.disabled {
            opacity: 0.45;
        }
        .step-card.disabled button {
            pointer-events: none;
            opacity: 0.65;
        }
        .card,
        .step-card {
            background: #FFFFFF;
            border-radius: 16px;
            border: 1px solid #E5E7EB;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .status-stack {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .step-card h2,
        .collapsible h2 {
            margin: 0;
            font-size: 18px;
            color: #0F172A;
        }
        .step-card p,
        .collapsible p {
            margin: 0;
            color: #4B5563;
            line-height: 1.5;
        }
        label {
            font-size: 14px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 4px;
        }
        input {
            border: 1px solid #D1D5DB;
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 15px;
            width: 100%;
            background: #FFFFFF;
        }
        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 12px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .button.button-primary.loading {
            opacity: 0.85;
            pointer-events: none;
        }
        .button-spinner {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.35);
            border-top-color: #FFFFFF;
            animation: buttonSpin 0.8s linear infinite;
        }
        @keyframes buttonSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .button-primary {
            background: #1D4ED8;
            color: #FFFFFF;
        }
        .button-primary:hover {
            background: #1E40AF;
        }
        .button-ghost {
            background: #FFFFFF;
            color: #1D4ED8;
            border: 1px solid #CBD5F5;
        }
        .button-ghost:hover {
            background: #F3F4F6;
        }
        .code-display {
            font-size: 40px;
            font-weight: 700;
            letter-spacing: 0.08em;
            color: #111827;
            text-align: center;
            padding: 12px 16px;
            border-radius: 12px;
            background: #F9FAFB;
            border: 1px dashed #CBD5F5;
        }
        .meta {
            font-size: 13px;
            color: #6B7280;
        }
        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 999px;
            padding: 6px 12px;
        }
        .status-pill span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-pill.neutral {
            background: #E5E7EB;
            color: #4B5563;
        }
        .status-pill.neutral span {
            background: #9CA3AF;
        }
        .status-pill.waiting {
            background: #FDF6B2;
            color: #92400E;
        }
        .status-pill.waiting span {
            background: #F59E0B;
        }
        .status-pill.success {
            background: #DEF7EC;
            color: #065F46;
        }
        .status-pill.success span {
            background: #059669;
        }
        .timeline {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 6px;
        }
        .timeline-item {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .timeline-item::before {
            content: "";
            width: 8px;
            height: 8px;
            background: #D1D5DB;
            border-radius: 50%;
            margin-top: 6px;
        }
        .legal-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .legal-list li {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 14px;
            line-height: 1.5;
            color: #374151;
        }
        .legal-list li::before {
            content: "‚Ä¢";
            color: #9CA3AF;
            font-size: 20px;
            line-height: 1;
            transform: translateY(-2px);
        }
        .session-state {
            border: 1px dashed #D1D5DB;
            border-radius: 14px;
            padding: 16px;
            background: #F9FAFB;
        }
        .session-log {
            border-radius: 12px;
            background: #1D212B;
            color: #E5E7EB;
            padding: 14px;
            font-size: 13px;
            max-height: 180px;
            overflow: auto;
            line-height: 1.4;
        }
        .session-log-entry + .session-log-entry {
            margin-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.08);
            padding-top: 8px;
        }
        .architecture-pill {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            background: #E5E7EB;
            padding: 4px 10px;
            border-radius: 999px;
            width: fit-content;
        }
        .session-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .waiting-copy {
            font-size: 14px;
            color: #4B5563;
            margin-top: 4px;
        }
        .collapsible {
            padding: 0;
            overflow: hidden;
            border: 1px solid #E5E7EB;
            border-radius: 16px;
            background: #FFFFFF;
            width: 100%;
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            cursor: pointer;
        }
        .collapsible-chevron {
            font-size: 18px;
            color: #6B7280;
            transition: transform 0.2s ease;
        }
        .collapsible.open .collapsible-chevron {
            transform: rotate(90deg);
        }
        .collapsible-content {
            padding: 0 20px 20px 20px;
            display: none;
            gap: 14px;
            flex-direction: column;
        }
        .collapsible.open .collapsible-content {
            display: flex;
        }
        @media (max-width: 900px) {
            .wizard-layout {
                flex-direction: column;
                align-items: stretch;
            }
        }
        @media (max-width: 720px) {
            .page-shell {
                padding: 28px 16px 40px;
            }
            .code-display {
                font-size: 32px;
            }
        }
    </style>
    <script>
        // Mobile detection - redirect before page loads
        (function() {
            const params = new URLSearchParams(window.location.search);
            const forceDesktop = params.get('device') === 'desktop';
            
            if (!forceDesktop) {
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                const isTouch = navigator.maxTouchPoints > 0;
                const narrowViewport = window.matchMedia('(max-width: 900px)').matches;
                const isMobile = /android|iphone|ipad|ipod|mobile/i.test(userAgent) || (isTouch && narrowViewport);
                
                if (isMobile) {
                    window.location.replace('mobile-upload.html');
                }
            }
        })();
    </script>
</head>
<body>
    <div class="page-shell">
        <header class="page-header">
            <div class="eyebrow">MMDCare</div>
            <h1>Starta en delningssession</h1>
            <p>G√• igenom stegen i ordning: generera kod, legitimera dig och inv√§nta patientens BankID. Fil√∂verf√∂ringen startar f√∂rst n√§r b√•da √§r verifierade.</p>
            <div class="chips">
                <span class="chip">SITHS</span>
                <span class="chip">BankID</span>
                <span class="chip">PDL/GDPR</span>
                </div>
        </header>

        <div class="wizard-layout">
            <div class="step-grid">
                <section class="step-card active" id="step1Card">
                    <div>
                        <p class="eyebrow" style="font-size:12px;letter-spacing:0.12em;">Steg 1 ¬∑ Eng√•ngskod</p>
                        <h2>Generera kod f√∂r patienten</h2>
                        <p>Skapar en ny sessionsmilj√∂ (45 min TTL) och loggar √•tkomsten.</p>
            </div>
                    <div class="session-actions">
                        <button class="button button-primary" id="generateCodeBtn">
                            Generera ny kod
                        </button>
                        <button class="button button-ghost" id="copyCodeBtn" disabled>Kopiera kod</button>
                    </div>
                    <div class="code-display" id="sessionCodeDisplay">‚Äì ‚Äì ‚Äì</div>
                    <div class="meta" id="codeMeta">Ingen aktiv session</div>
                    <div class="meta" id="step1Status">Dela eng√•ngskoden med patienten.</div>
                </section>

                <section class="step-card" id="sithsCard">
                    <div>
                        <p class="eyebrow" style="font-size:12px;letter-spacing:0.12em;">Steg 2 ¬∑ L√§kare legitimerar sig</p>
                        <h2>SITHS identifiering</h2>
                        <p>Verifierar personlig beh√∂righet och kopplar dig till vald v√•rdgivare.</p>
                </div>
                    <div class="session-actions">
                        <button class="button button-primary" id="startSithsBtn">Starta SITHS legitimering</button>
                        <button class="button button-ghost" id="resetSithsBtn">√Öterst√§ll status</button>
                    </div>
                    <div id="sithsStatusPill" class="status-pill neutral">
                        <span></span>
                        <div>Ej p√•b√∂rjad</div>
                    </div>
                    <div class="timeline">
                        <div class="timeline-item">
                            <div>
                                <strong>Personligt SITHS-certifikat</strong>
                                <span>Verifierar att du √§r legitimerad v√•rdpersonal.</span>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div>
                                <strong>Beh√∂righetsstyrning</strong>
                                <span>HSLF-FS 2016:40 ‚Äì kopplar roll, v√•rdgivare och √§ndam√•l.</span>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="status-stack">
                <section class="collapsible open" id="sessionStatusCard">
                    <div class="collapsible-header">
                        <h2>Sessionsstatus</h2>
                        <span class="collapsible-chevron">‚Ä∫</span>
        </div>
                    <div class="collapsible-content">
                        <div class="session-state">
                            <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
                                <div id="doctorStatusPill" class="status-pill neutral">
                                    <span></span>
                                    <div>L√§kare</div>
                                </div>
                                <div id="patientStatusPill" class="status-pill neutral">
                                    <span></span>
                                    <div>Patient</div>
                                </div>
                                <div id="sessionReadyPill" class="status-pill neutral">
                                    <span></span>
                                    <div>Session</div>
                                </div>
                            </div>
                            <p class="waiting-copy" id="sessionCopy">Generera kod f√∂r att starta fl√∂det.</p>
                        </div>
                        <div class="session-actions">
                            <button class="button button-ghost" id="cancelSessionBtn">Avsluta session</button>
                        </div>
                    </div>
                </section>

                <section class="collapsible" id="legalCard">
                    <div class="collapsible-header">
                        <h2>Juridiskt fl√∂de</h2>
                        <span class="collapsible-chevron">‚Ä∫</span>
                    </div>
                    <div class="collapsible-content">
                        <ul class="legal-list">
                            <li>Patienten informeras om l√§kare, att data speglas flyktigt, tidsbegr√§nsning, ej lagring samt att √•tkomst loggas.</li>
                            <li>Samtycke loggas enligt GDPR art. 6.1(a) + 9.2(a). Endast √•tkomstlogg (ej datapayload) sparas i 5 √•r.</li>
                            <li>L√§karen identifieras med SITHS, kopplas till roll och v√•rdgivare och beh√∂righetsstyrningen kontrolleras.</li>
                            <li>N√§r b√•da √§r verifierade skapas ett krypterat sessions-ID d√§r filerna endast lever i RAM, read-only.</li>
                        </ul>
                        <p class="meta">Efter 45 minuter st√§ngs sessionen och all speglad data raderas automatiskt.</p>
                    </div>
                </section>
            </div>
    </div>

    <script>
        const SESSION_TTL_MINUTES = 45;
        const stageNoticeStorageKey = 'mmd_stage_notices';
        let seenStageNotices = new Set();
        try {
            const storedStages = JSON.parse(sessionStorage.getItem(stageNoticeStorageKey) || '[]');
            if (Array.isArray(storedStages)) {
                seenStageNotices = new Set(storedStages);
            }
        } catch (error) {
            // ignore storage parsing errors
        }

        function shouldShowStageNotice(stage) {
            return stage && !seenStageNotices.has(stage);
        }

        function markStageNotice(stage) {
            if (!stage) return;
            seenStageNotices.add(stage);
            try {
                sessionStorage.setItem(stageNoticeStorageKey, JSON.stringify(Array.from(seenStageNotices)));
            } catch (error) {
                // ignore quota issues
            }
        }

        const state = {
            transferId: null,
            sessionCode: null,
            patientAlias: 'Patient',
            doctorVerified: false,
            patientVerified: false,
            patientStage: 'waiting',
            pollIntervalId: null,
            initialFileCount: 0,
            uploadDetected: false,
            redirectScheduled: false
        };
        let patientStagePollId = null;
        let lastStageNotified = null;

        const elements = {
            generateCodeBtn: document.getElementById('generateCodeBtn'),
            copyCodeBtn: document.getElementById('copyCodeBtn'),
            sessionCodeDisplay: document.getElementById('sessionCodeDisplay'),
            codeMeta: document.getElementById('codeMeta'),
            sessionLog: document.getElementById('sessionLog'),
            doctorStatusPill: document.getElementById('doctorStatusPill'),
            patientStatusPill: document.getElementById('patientStatusPill'),
            sessionReadyPill: document.getElementById('sessionReadyPill'),
            sessionCopy: document.getElementById('sessionCopy'),
            startSithsBtn: document.getElementById('startSithsBtn'),
            resetSithsBtn: document.getElementById('resetSithsBtn'),
            sithsStatusPill: document.getElementById('sithsStatusPill'),
            cancelSessionBtn: document.getElementById('cancelSessionBtn')
        };
        const stepIds = ['step1Card', 'sithsCard'];

        document.addEventListener('DOMContentLoaded', () => {
            hydrateStateFromStorage();
            wireEvents();
            setupStepFlow();
            setupCollapsibles();
            updateStatusUI();
            listenForStorageEvents();
        });

        function hydrateStateFromStorage() {
            state.transferId = null;
            state.sessionCode = null;
            state.patientAlias = 'Patient';
            state.doctorVerified = false;
            state.patientVerified = false;
            state.patientStage = 'waiting';
            state.uploadDetected = false;
            state.redirectScheduled = false;
            elements.sessionCodeDisplay.textContent = '‚Äì ‚Äì ‚Äì';
            elements.copyCodeBtn.disabled = true;
            updateCodeMeta('Ingen aktiv session');
            updateStepStatuses('waiting');
        }

        function setupStepFlow() {
            const initialStep = state.patientVerified ? 'sithsCard' : 'step1Card';
            showStep(initialStep);
        }

        function showStep(stepId) {
            stepIds.forEach(id => {
                const card = document.getElementById(id);
                if (card) {
                    card.classList.toggle('active', true);
                }
            });
        }

        function wireEvents() {
            elements.generateCodeBtn.addEventListener('click', generateNewCode);
            elements.copyCodeBtn.addEventListener('click', copyCodeToClipboard);
            elements.startSithsBtn.addEventListener('click', simulateSithsFlow);
            elements.resetSithsBtn.addEventListener('click', resetSithsStatus);
            elements.cancelSessionBtn.addEventListener('click', cancelSession);
        }

        function listenForStorageEvents() {
            window.addEventListener('storage', (event) => {
                if (event.key === 'mmd_patient_verification') {
                    const payload = readJSON('mmd_patient_verification');
                    if (payload && matchesCurrentCode(payload.code)) {
                        state.patientVerified = payload.verified === true;
                        addLogEntry('Patient legitimerades med BankID.');
                        updateStatusUI();
                        maybeStartMonitoring();
                        handlePatientVerification();
                    }
                }
            });
        }

        function matchesCurrentCode(code) {
            return state.sessionCode && code === state.sessionCode;
        }

        function startPatientVerificationPoll() {
            stopPatientVerificationPoll();
            if (!state.sessionCode || state.patientVerified) {
                updateStepStatuses(state.patientVerified ? 'approved' : 'waiting');
                return;
            }
            patientStagePollId = setInterval(checkPatientStageFromServer, 3000);
            checkPatientStageFromServer();
        }

        function stopPatientVerificationPoll() {
            if (patientStagePollId) {
                clearInterval(patientStagePollId);
                patientStagePollId = null;
            }
        }

        async function checkPatientStageFromServer() {
            if (!state.sessionCode) return;
            try {
                const res = await fetch(`/api/session-code?code=${encodeURIComponent(state.sessionCode)}`, { cache: 'no-store' });
                if (!res.ok) return;
                const data = await res.json();
                if (data.patientAlias) {
                    state.patientAlias = data.patientAlias;
                }
                const stage = data.stage || (data.patientVerified ? 'approved' : 'waiting');
                if (stage !== state.patientStage) {
                    if (stage === 'initiated') {
                        addLogEntry('Patienten p√•b√∂rjade sessionen p√• mobilen.');
                    } else if (stage === 'bankid') {
                        addLogEntry('Patienten identifierar sig nu med BankID.');
                    } else if (stage === 'approved') {
                        addLogEntry('Patienten identifierades med BankID.');
                    } else if (stage === 'uploading') {
                        addLogEntry('Patienten laddar upp dokument‚Ä¶');
                    } else if (stage === 'uploaded') {
                        addLogEntry('Patienten har laddat upp dokument.');
                    }
                    updateStepStatuses(stage);
                    announceStage(stage);
                    updateStatusUI();
                }
                if (stage === 'uploading') {
                    state.uploadingNotified = true;
                }
                if (stage === 'uploaded' && !state.uploadDetected) {
                    handleMobileUploadDetected();
                }
                if ((data.patientVerified || stage === 'approved') && !state.patientVerified) {
                    state.patientVerified = true;
                    handlePatientVerification();
                    updateStatusUI();
                    stopPatientVerificationPoll();
                }
            } catch (error) {
                console.error('Failed to kontrollera patientstatus:', error);
            }
        }

        function updateStepStatuses(stage = 'waiting') {
            state.patientStage = stage;
            const step1Status = document.getElementById('step1Status');
            const sithsCard = document.getElementById('sithsCard');

            let step1Text = 'Dela eng√•ngskoden med patienten.';
            if (stage === 'initiated') {
                step1Text = 'Patienten √∂ppnade sessionen och granskar samtycket.';
            } else if (stage === 'bankid') {
                step1Text = 'Patienten har godk√§nt villkoren och legitimerar sig.';
            } else if (stage === 'approved') {
                step1Text = 'Patienten √§r klar ‚Äì h√•ll SITHS-kortet redo.';
            } else if (stage === 'uploading') {
                step1Text = 'Patienten laddar upp dokument just nu.';
            } else if (stage === 'uploaded') {
                step1Text = 'Filer mottagna ‚Äì bearbetar data.';
            }
            if (step1Status) {
                step1Status.textContent = step1Text;
            }

            if (sithsCard) {
                const shouldDisable = stage !== 'approved';
                sithsCard.classList.toggle('disabled', shouldDisable);
                if (elements.startSithsBtn) {
                    elements.startSithsBtn.disabled = shouldDisable;
                }
            }
        }

        async function generateNewCode() {
            setGenerateButtonLoading(true);
            try {
                const patientAlias = state.patientAlias?.trim() || 'Patient';
                const transferData = await createTransfer(patientAlias);
                if (!transferData) {
                    updateCodeMeta('Kunde inte skapa session ‚Äì f√∂rs√∂k igen.');
                    return;
                }

                const { transferId, sessionCode, patientAlias: aliasFromServer, doctorName } = transferData;
                if (!transferId || !sessionCode) {
                    updateCodeMeta('Servern kunde inte skapa kod.');
                    return;
                }

                state.transferId = transferId;
                state.sessionCode = sessionCode;
                state.patientAlias = aliasFromServer || patientAlias;
                state.doctorVerified = false;
                state.patientVerified = false;
                state.patientStage = 'waiting';
                state.uploadDetected = false;
                state.redirectScheduled = false;
                lastStageNotified = null;
                seenStageNotices.clear();
                try {
                    sessionStorage.removeItem(stageNoticeStorageKey);
                } catch (error) {
                    // ignore
                }

                localStorage.setItem('currentTransferId', transferId);
                localStorage.setItem('currentPatientName', state.patientAlias);
                localStorage.removeItem('mmd_patient_verification');
                localStorage.removeItem('mmd_doctor_verification');

                renderSessionCode(sessionCode);
                elements.copyCodeBtn.disabled = false;
                updateCodeMeta(`Delas med patienten ¬∑ Kod g√§ller i ${SESSION_TTL_MINUTES} minuter.`);
                addLogEntry(`Ny session skapad f√∂r ${state.patientAlias}. TransferID: ${transferId}`);
                markSessionStage('waiting');
                announceStage('waiting');
                updateStatusUI();
                startPatientVerificationPoll();
                showStep('step1Card');
            } catch (error) {
                console.error(error);
                updateCodeMeta('Ett fel uppstod n√§r koden skulle genereras.');
            } finally {
                setGenerateButtonLoading(false);
            }
        }

        function setGenerateButtonLoading(isLoading) {
            const btn = elements.generateCodeBtn;
            if (!btn) return;
            if (isLoading) {
                if (!btn.dataset.originalText) {
                    btn.dataset.originalText = btn.textContent.trim();
                }
                btn.classList.add('loading');
                btn.disabled = true;
                btn.innerHTML = `<span class="button-spinner" aria-hidden="true"></span><span>Genererar...</span>`;
            } else {
                const originalText = btn.dataset.originalText || 'Generera ny kod';
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function createTransfer(patientAlias) {
            try {
                const payload = { patientId: slugify(patientAlias), patientAlias, doctorName: resolveDoctorName() };
                const res = await fetch('/api/transfers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || 'Kunde inte skapa transfer.');
                }
                const data = await res.json();
                return data;
            } catch (error) {
                console.error('Transfer creation failed', error);
                return null;
            }
        }

        function renderSessionCode(code) {
            elements.sessionCodeDisplay.textContent = code;
        }

        function updateCodeMeta(text) {
            elements.codeMeta.textContent = text;
        }

        function copyCodeToClipboard() {
            if (!state.sessionCode) return;
            navigator.clipboard.writeText(state.sessionCode).then(() => {
                updateCodeMeta('Kod kopierad. Dela den s√§kert via telefon eller m√∂te.');
            });
        }

        function simulateSithsFlow() {
            if (!state.sessionCode) {
                addLogEntry('Generera en kod innan SITHS p√•b√∂rjas.');
                return;
            }
            if (!state.patientVerified) {
                addLogEntry('Patienten m√•ste f√∂rst godk√§nna innan SITHS kan startas.');
                    return;
            }
            setSithsStatus('waiting', 'Kort insatt, verifierar certifikat...');
            addLogEntry('SITHS-legitimering initierades.');
            setTimeout(() => setSithsStatus('waiting', 'Kontrollerar roll & beh√∂righet...'), 1800);
            setTimeout(() => {
                state.doctorVerified = true;
                storeDoctorVerification();
                setSithsStatus('success', 'Legitimerad ¬∑ beh√∂righet verifierad.');
                addLogEntry('L√§karen legitimerade sig via SITHS.');
                markDoctorVerificationOnServer(true);
                updateStatusUI();
                maybeStartMonitoring();
                redirectToDashboard();
            }, 3200);
        }

        function resetSithsStatus() {
            state.doctorVerified = false;
            localStorage.removeItem('mmd_doctor_verification');
            setSithsStatus('neutral', 'Ej p√•b√∂rjad');
            markDoctorVerificationOnServer(false);
            updateStatusUI();
        }

        function setSithsStatus(status, text) {
            const pill = elements.sithsStatusPill;
            pill.className = `status-pill ${status}`;
            pill.querySelector('div').textContent = text;
        }

        function storeDoctorVerification() {
            localStorage.setItem('mmd_doctor_verification', JSON.stringify({
                verified: true,
                method: 'siths',
                code: state.sessionCode,
                verifiedAt: new Date().toISOString()
            }));
        }

        function updateStatusUI() {
            renderStatusPill(elements.doctorStatusPill, state.doctorVerified, 'L√§kare verifierad');
            renderStatusPill(elements.patientStatusPill, state.patientVerified, 'Patient verifierad');

            const ready = Boolean(state.transferId && state.sessionCode && state.doctorVerified && state.patientVerified);
            if (ready) {
                elements.sessionReadyPill.className = 'status-pill success';
                elements.sessionReadyPill.querySelector('div').textContent = 'Session aktiv';
                elements.sessionCopy.textContent = 'B√•da parter verifierade. V√§ntar p√• filer fr√•n mobilen.';
            } else if (state.transferId) {
                elements.sessionReadyPill.className = 'status-pill waiting';
                elements.sessionReadyPill.querySelector('div').textContent = 'V√§ntar';
                elements.sessionCopy.textContent = sessionCopyForStage();
                } else {
                elements.sessionReadyPill.className = 'status-pill neutral';
                elements.sessionReadyPill.querySelector('div').textContent = 'Session';
                elements.sessionCopy.textContent = 'Generera kod f√∂r att starta fl√∂det.';
            }
            updateStepStatuses(state.patientStage);
        }

        function renderStatusPill(element, isDone, label) {
            if (isDone) {
                element.className = 'status-pill success';
                element.querySelector('div').textContent = label;
                } else {
                element.className = 'status-pill waiting';
                element.querySelector('div').textContent = `${label.split(' ')[0]} v√§ntar`;
            }
        }

        async function markDoctorVerificationOnServer(verified = true) {
            if (!state.sessionCode) return;
            try {
                await fetch('/api/session-code/doctor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: state.sessionCode, verified })
                });
            } catch (error) {
                console.error('Kunde inte uppdatera doktorstatus p√• servern:', error);
            }
        }

        async function markSessionStage(stage) {
            if (!state.sessionCode || !stage) return;
            try {
                await fetch('/api/session-code/stage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: state.sessionCode, stage })
                });
            } catch (error) {
                console.error('Kunde inte uppdatera sessionsfasen:', error);
            }
        }

        function redirectToDashboard() {
            if (!state.transferId || state.redirectScheduled) return;
            state.redirectScheduled = true;
            localStorage.setItem('currentTransferId', state.transferId);
            localStorage.setItem('currentPatientName', state.patientAlias);
            setTimeout(() => window.location.href = 'dashboard.html', 900);
        }

        function sessionCopyForStage() {
            if (!state.transferId) return 'Generera kod f√∂r att starta fl√∂det.';
            switch (state.patientStage) {
                case 'initiated':
                    return 'Session p√•b√∂rjad av patient.';
                case 'bankid':
                    return 'Patienten identifierar sig med BankID.';
                case 'approved':
                    return state.doctorVerified
                        ? 'Patienten har identifierat sig ‚Äì √∂ppnar √∂versikten.'
                        : 'Patienten har identifierat sig ‚Äì din tur att legitimera dig.';
                case 'uploading':
                    return 'Patienten laddar upp dokument ‚Äì h√•ll f√∂nstret √∂ppet.';
                case 'uploaded':
                    return 'Filer mottagna ‚Äì data visas strax.';
                default:
                    return 'V√§ntar p√• patient.';
            }
        }

        function announceStage(stage) {
            if (!stage || lastStageNotified === stage) return;
            if (!shouldShowStageNotice(stage)) return;
            markStageNotice(stage);
            lastStageNotified = stage;
            const messages = {
                waiting: 'V√§ntar p√• patientens godk√§nnande.',
                initiated: 'Session p√•b√∂rjad av patient.',
                bankid: 'Patienten identifierar sig med BankID.',
                approved: 'Patienten har identifierat sig.',
                uploading: 'Patienten laddar upp dokument‚Ä¶',
                uploaded: 'Patienten har laddat upp dokument.'
            };
            const types = {
                waiting: 'waiting',
                initiated: 'waiting',
                bankid: 'waiting',
                approved: 'success',
                uploading: 'waiting',
                uploaded: 'success'
            };
            const text = messages[stage];
            if (text) {
                showUploadNotification(text, types[stage] || 'waiting');
            }
        }

        function addLogEntry(message) {
            if (!elements.sessionLog) return;
            const entry = document.createElement('div');
            entry.className = 'session-log-entry';
            entry.innerHTML = `<strong>${new Date().toLocaleTimeString('sv-SE')}</strong> ¬∑ ${message}`;
            if (elements.sessionLog.children.length === 1 && elements.sessionLog.firstElementChild.textContent.includes('Ingen')) {
                elements.sessionLog.innerHTML = '';
            }
            elements.sessionLog.prepend(entry);
        }

        function readJSON(key) {
            const value = localStorage.getItem(key);
            if (!value) return null;
            try {
                return JSON.parse(value);
            } catch (error) {
                console.error('JSON parse error', key, error);
                return null;
            }
        }

        function slugify(value) {
            return value
                .toLowerCase()
                .replace(/√•|√§/g, 'a')
                .replace(/√∂/g, 'o')
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '') || `patient-${Date.now()}`;
        }

        function resolveDoctorName() {
            const auth = readJSON('mmdcare_auth');
            return auth?.doctorName || 'Dr. Anna Andersson';
        }

        function maybeStartMonitoring() {
            if (state.transferId && state.doctorVerified && state.patientVerified && !state.pollIntervalId) {
                startFileMonitoring();
            }
        }

        function startFileMonitoring() {
            if (!state.transferId) return;
            clearPolling();
            state.uploadDetected = false;
            addLogEntry('Session aktiv ‚Äì v√§ntar p√• filuppladdning.');
            checkInitialTransferStatus().then(() => {
                if (!state.transferId) return;
                state.pollIntervalId = setInterval(pollForUploads, 1000);
                pollForUploads();
            });
        }

        function clearPolling() {
            if (state.pollIntervalId) {
                clearInterval(state.pollIntervalId);
                state.pollIntervalId = null;
            }
        }

        async function checkInitialTransferStatus() {
            if (!state.transferId) return;
            try {
                const res = await fetch(`/api/complete?transferId=${state.transferId}`, { cache: 'no-store' });
                    if (res.ok) {
                        const data = await res.json();
                    state.initialFileCount = data.files?.length || 0;
                } else {
                    state.initialFileCount = 0;
                }
            } catch (error) {
                console.error('Initial status failed', error);
                state.initialFileCount = 0;
            }
        }

        async function pollForUploads() {
            if (!state.transferId || state.uploadDetected || state.redirectScheduled) return;
            try {
                const res = await fetch(`/api/complete?transferId=${state.transferId}`, { cache: 'no-store' });
                if (!res.ok) return;
                const data = await res.json();
                const currentCount = data.files?.length || 0;
                if (currentCount > state.initialFileCount && currentCount > 0) {
                    handleMobileUploadDetected();
                }
            } catch (error) {
                console.error('Polling error', error);
            }
        }

        function handleMobileUploadDetected() {
            state.uploadDetected = true;
            clearPolling();
            addLogEntry('üéâ Filer har laddats upp. √ñversikten √∂ppnas.');
            showUploadNotification('Filer mottagna ‚Äì √∂ppnar √∂versikten', 'success');
            localStorage.setItem('currentTransferId', state.transferId);
            localStorage.setItem('currentPatientName', state.patientAlias);
            if (!state.redirectScheduled) {
                state.redirectScheduled = true;
                setTimeout(() => window.location.href = 'dashboard.html', 1200);
            }
        }

        function cancelSession() {
            clearPolling();
            stopPatientVerificationPoll();
            if (state.sessionCode) {
                markDoctorVerificationOnServer(false);
                markSessionStage('cancelled');
            }
            state.transferId = null;
            state.sessionCode = null;
            state.patientAlias = 'Patient';
            state.doctorVerified = false;
            state.patientVerified = false;
            state.patientStage = 'waiting';
            state.uploadDetected = false;
            state.redirectScheduled = false;
            lastStageNotified = null;
            localStorage.removeItem('currentTransferId');
            localStorage.removeItem('currentPatientName');
            localStorage.removeItem('mmd_patient_verification');
            localStorage.removeItem('mmd_doctor_verification');
            elements.sessionCodeDisplay.textContent = '‚Äì ‚Äì ‚Äì';
            elements.copyCodeBtn.disabled = true;
            updateCodeMeta('Session avbruten.');
            addLogEntry('Sessionen avbr√∂ts manuellt.');
            updateStatusUI();
            resetSithsStatus();
            updateStepStatuses('waiting');
            showStep('step1Card');
        }

        function handlePatientVerification() {
            if (!state.patientVerified) return;
            state.patientStage = 'approved';
            updateStepStatuses('approved');
            announceStage('approved');
            stopPatientVerificationPoll();
            addLogEntry('Patienten godk√§nde delningen och legitimerade sig.');
            maybeStartMonitoring();
            showStep('sithsCard');
        }

        function setupCollapsibles() {
            document.querySelectorAll('.collapsible').forEach(section => {
                const header = section.querySelector('.collapsible-header');
                if (!header) return;
                header.addEventListener('click', () => {
                    section.classList.toggle('open');
                });
            });
        }

        function showUploadNotification(message, type = 'waiting') {
            const existing = document.querySelector('.upload-notification');
            if (existing) existing.remove();

            const indicatorColor = type === 'success' ? '#10B981' : '#2563EB';
            const notification = document.createElement('div');
            notification.className = 'upload-notification';
            notification.style.cssText = `
                position: fixed;
                top: 24px;
                right: 24px;
                background: #0f172a;
                color: white;
                padding: 16px 24px;
                border-radius: 14px;
                border: 1px solid rgba(148,163,184,0.25);
                box-shadow: 0 20px 40px rgba(15,23,42,0.35);
                font-size: 14px;
                z-index: 9999;
                white-space: nowrap;
            `;
            notification.innerHTML = `
                <div style="display:flex;align-items:center;gap:12px;">
                    <span style="width:12px;height:12px;border-radius:50%;background:${indicatorColor};display:inline-block;"></span>
                    <strong>${message}</strong>
                </div>
            `;
            document.body.appendChild(notification);
            if (type === 'success') {
                setTimeout(() => notification.remove(), 2500);
            }
        }

        const pendingSessionNotice = sessionStorage.getItem('session_notice');
        if (pendingSessionNotice) {
            sessionStorage.removeItem('session_notice');
            showUploadNotification(pendingSessionNotice, 'info');
        }

        window.addEventListener('beforeunload', () => {
            clearPolling();
        });
    </script>
</body>
</html>

